<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G√©n√©rateur + mini CRM (CSV+statuts)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1250px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    p { margin: 0 0 14px; color: #444; }
    .grid { display: grid; grid-template-columns: 1.15fr 0.85fr; gap: 12px; }
    .card { background:#fafafa; border:1px solid #eee; border-radius:16px; padding:14px; }
    label { display:block; font-weight:700; margin: 10px 0 6px; }
    input, select, textarea, button {
      width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; font-size:14px;
    }
    textarea { min-height:160px; resize: vertical; }
    button { cursor:pointer; border:none; background:#1f7a5b; color:#fff; font-weight:800; }
    button.secondary { background:#444; }
    button.ghost { background:#eaeaea; color:#222; border:1px solid #ddd; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .small { font-size:12px; color:#666; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e9f5ef; border:1px solid #cfe8dd; font-size:12px; color:#185a43; }
    table { width:100%; border-collapse: collapse; margin-top:10px; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { border-bottom:1px solid #eee; padding:8px; font-size:13px; text-align:left; vertical-align:top; }
    th { background:#f3f3f3; }
    tr:hover { background:#fbfbfb; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .inline > * { flex: 1; min-width: 180px; }
    .badge-urgent { display:inline-block; padding:2px 8px; border-radius:999px; background:#ffe1e1; color:#8b1d1d; border:1px solid #f1bcbc; font-size:11px; font-weight:700; }
    .contact-info { white-space: pre-line; }
  </style>
</head>
<body>
  <h1>G√©n√©rateur de messages + mini CRM</h1>
  <p>
    <span class="pill">CSV + statuts + relances auto</span> ‚Ä¢ gratuit ‚Ä¢ fonctionne partout
  </p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row3">
        <div>
          <label for="prenom">Pr√©nom</label>
          <input id="prenom" placeholder="Ex: Julie" />
        </div>
        <div>
          <label for="plateforme">Plateforme</label>
          <select id="plateforme">
            <option>Instagram</option>
            <option>Facebook</option>
            <option>TikTok</option>
            <option>LinkedIn</option>
            <option>WhatsApp</option>
          </select>
        </div>
        <div>
          <label for="marche">March√©</label>
          <select id="marche">
            <option value="froid">Froid</option>
            <option value="ti√®de">Ti√®de</option>
            <option value="chaud">Chaud</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label for="objectif">Sujet</label>
          <select id="objectif">
            <option value="discussion">Discussion</option>
            <option value="question">Question</option>
            <option value="invitation">Invitation</option>
            <option value="relance7">Relance J+7</option>
            <option value="relance14">Relance J+14</option>
          </select>
        </div>

        <div>
          <label for="relation_type">Type de relation</label>
          <select id="relation_type">
            <option value="prospect">Prospect</option>
            <option value="client">Client</option>
            <option value="nouvelle rencontre">Nouvelle rencontre</option>
            <option value="partenariat">Partenariat</option>
            <option value="ami">Ami</option>
            <option value="famille">Famille</option>
            <option value="coll√®gues">Coll√®gues</option>
            <option value="autre">Autre</option>
          </select>
        </div>

        <div>
          <label for="styleTone">Style</label>
          <select id="styleTone">
            <option value="neutre">Neutre</option>
            <option value="pro">Pro</option>
            <option value="fun">Fun</option>
          </select>
        </div>

        <div>
          <label for="lengthMode">Longueur</label>
          <select id="lengthMode">
            <option value="court">Court</option>
            <option value="normal" selected>Normal</option>
            <option value="long">Long</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label for="persona">Type de personne</label>
          <select id="persona">
            <option value="entrepreneur">Entrepreneur / business</option>
            <option value="parent">Parent / famille</option>
            <option value="sportif">Sportif / sant√©</option>
            <option value="voyage">Voyage / lifestyle</option>
            <option value="etudiant">√âtudiant / d√©but de carri√®re</option>
            <option value="createur">Cr√©ateur / contenu</option>
            <option value="job">Salari√© / carri√®re</option>
            <option value="indefini" selected>Ind√©fini</option>
          </select>
        </div>

        <div>
          <label for="intention">Intention</label>
          <select id="intention">
            <option value="reseau" selected>R√©seau / discuter</option>
            <option value="opportunite">Opportunit√© (soft)</option>
            <option value="collab">Collab / projet</option>
            <option value="curiosite">Curiosit√© / apprendre</option>
          </select>
        </div>

        <div>
          <label for="statut">Statut</label>
          <select id="statut">
            <option value="Nouveau">Nouveau</option>
            <option value="R√©pondu">R√©pondu</option>
            <option value="√Ä relancer" selected>√Ä relancer</option>
            <option value="RDV pris">RDV pris</option>
            <option value="√Ä ne plus contacter">√Ä ne plus contacter</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="dernier">Dernier contact</label>
          <input id="dernier" type="date" />
          <div class="small">Optionnel : sert au contexte du message.</div>
        </div>
        <div>
          <label for="prochaine">Prochaine relance</label>
          <input id="prochaine" type="date" />
          <div class="small">Peut √™tre auto-remplie quand tu ‚ÄúAjoutes/MAJ‚Äù.</div>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="centre">Centres d‚Äôint√©r√™t</label>
          <input id="centre" placeholder="Ex: sport, voyage..." />
        </div>
        <div>
          <label for="dateCreation">Date cr√©ation</label>
          <input id="dateCreation" type="date" disabled />
          <div class="small">Automatique √† la premi√®re sauvegarde.</div>
        </div>
      </div>

      <label for="accroche">Accroche / contexte</label>
      <input id="accroche" placeholder="Ex: ta story / ton post..." />

      <label for="note">Note (CRM)</label>
      <input id="note" placeholder="Ex: aime voyager, relance mardi, etc." />

      <div class="row2">
        <div>
          <label for="telephone">T√©l√©phone</label>
          <input id="telephone" placeholder="Ex: +33 6 12 34 56 78" />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="Ex: contact@email.com" />
        </div>
      </div>

      <div class="actions">
        <button id="btnGen">G√©n√©rer</button>
        <button class="ghost" id="btnRandom">üé≤ Variante</button>
        <button class="ghost" id="btnCopy">Copier</button>
        <button class="secondary" id="btnClear">Effacer</button>
      </div>

      <div class="small" id="daysInfo"></div>

      <label for="result">Message g√©n√©r√©</label>
      <textarea id="result" readonly></textarea>

      <div class="small mono" id="debug" style="margin-top:8px;"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="inline">
        <div>
          <label for="contactSelect">Contacts</label>
          <select id="contactSelect"></select>
          <div class="small">S√©lectionne ‚Üí √ßa remplit le formulaire.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="ghost" id="btnAdd">+ Ajouter/Mettre √† jour</button>
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnMarkReplied">Marquer comme R√©pondu</button>
        <button class="ghost" id="btnPlan7">Planifier relance J+7</button>
        <button class="ghost" id="btnPlan14">Planifier relance J+14</button>
      </div>

      <div class="actions">
        <button class="ghost" id="btnCopyPhone" disabled>Copier tel</button>
        <button class="ghost" id="btnCopyEmail" disabled>Copier email</button>
      </div>

      <div class="small contact-info" id="contactInfo"></div>

      <div class="actions">
        <button class="ghost" id="btnExport">Exporter CSV</button>
        <button class="ghost" id="btnImportBtn">Importer CSV</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none;" />
        <button class="secondary" id="btnDelete">Supprimer contact</button>
      </div>

      <div class="small">
        Colonnes CSV :
        <span class="mono">prenom,plateforme,marche,relation_type,telephone,email,objectif,style,longueur,persona,intention,statut,date_creation,dernier,prochaine_relance,centre,accroche,note</span>
      </div>

      <div class="row2">
        <div>
          <label for="filterSelect">Filtre</label>
          <select id="filterSelect">
            <option value="all">Tous</option>
            <option value="urgent">Urgent</option>
            <option value="relance">√Ä relancer</option>
            <option value="rdv">RDV pris</option>
          </select>
        </div>
        <div>
          <label for="searchInput">Recherche</label>
          <input id="searchInput" placeholder="Pr√©nom ou note..." />
        </div>
      </div>

      <div class="small" id="relanceCount" style="margin-top:8px;"></div>

      <table>
        <thead>
          <tr>
            <th>Pr√©nom</th>
            <th>Plateforme</th>
            <th>Statut</th>
            <th>Prochaine relance</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="contactTableBody"></tbody>
      </table>

      <div class="small" style="margin-top:10px;">
        Astuce : ‚Äú√Ä relancer‚Äù + Objectif = Relance J+7/J+14 ‚Üí calcule automatiquement la prochaine relance.
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clean = (s) => (s || "").trim();
    const STORAGE_KEY = "mlm_contacts_v2";
    let selectedKey = "";
    const eventBindings = new WeakMap();

    function addListenerOnce(id, eventName, handler) {
      const el = $(id);
      if (!el) return;
      const signature = `${eventName}:${handler.name || "anonymous"}`;
      const registered = eventBindings.get(el) || new Set();
      if (registered.has(signature)) return;
      el.addEventListener(eventName, handler);
      registered.add(signature);
      eventBindings.set(el, registered);
    }

    function warnDuplicateIds() {
      const idMap = new Map();
      document.querySelectorAll("[id]").forEach((el) => {
        const id = el.id;
        idMap.set(id, (idMap.get(id) || 0) + 1);
      });
      idMap.forEach((count, id) => {
        if (count > 1) console.warn(`ID dupliqu√© d√©tect√©: #${id} (${count} occurrences)`);
      });
    }

    function normalizePhone(value) {
      return clean(value).replace(/\s+/g, " ");
    }

    function normalizeEmail(value) {
      return clean(value).toLowerCase();
    }

    function isValidEmail(value) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    }

    // --------- dates helpers ---------
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseISODate(iso) {
      if (!iso) return null;
      const d = new Date(`${iso}T00:00:00`);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function daysDiff(aISO, bISO) {
      const a = parseISODate(aISO);
      const b = parseISODate(bISO);
      if (!a || !b) return null;
      const diffMs = b.getTime() - a.getTime();
      return Math.round(diffMs / (1000 * 60 * 60 * 24));
    }

    function addDaysISO(baseISO, addDays) {
      const base = baseISO ? new Date(baseISO + "T00:00:00") : new Date();
      const d = new Date(base.getTime());
      d.setDate(d.getDate() + addDays);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function daysSince(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr + "T00:00:00");
      const now = new Date();
      const ms = now - d;
      if (isNaN(ms)) return null;
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function formatFollowUpSuffix(dateISO) {
      const diff = daysDiff(todayISO(), dateISO);
      if (diff == null) return "";
      if (diff === 0) return " (J+0)";
      if (diff > 0) return ` (J-${diff})`;
      return ` (J+${Math.abs(diff)})`;
    }

    // --------- message generator (same engine) ---------
    function tonePacks(style, plateforme, prenom) {
      const packs = {
        pro: { hello:[`Bonjour ${prenom},`,`Bonjour ${prenom} üëã`,`Hello ${prenom},`], outro:[`Bonne journ√©e,`,`Au plaisir d‚Äô√©changer,`,`Bien √† vous,`] },
        neutre: { hello:[`Salut ${prenom} !`,`Hello ${prenom} üëã`,`Coucou ${prenom} !`], outro:[`Bonne journ√©e √† toi ‚ú®`,`√Ä bient√¥t üôÇ`,`Force √† toi üí™`] },
        fun: { hello:[`Yo ${prenom} üòÑ`,`Hey ${prenom} üëã`,`Coucou ${prenom} üòÑ`], outro:[`Belle journ√©e √† toi ‚ú®`,`√Ä tr√®s vite üòÑ`,`Force & good vibes üí™`], funWords:[`la jungle de ${plateforme}`,`le vortex des notifications`,`l‚Äôalgorithme farceur`] }
      };
      return packs[style] || packs.neutre;
    }

    function personaLine(persona, styleKey) {
      const map = {
        entrepreneur:{ pro:`J‚Äôaime bien √©changer avec des personnes orient√©es projets.`, neutre:`J‚Äôaime bien connecter avec des gens qui construisent des projets.`, fun:`J‚Äôaime les gens qui build des trucs üòÑ` },
        parent:{ pro:`√âchanger avec des personnes qui jonglent avec la vie de famille, c‚Äôest toujours int√©ressant.`, neutre:`Respect √† ceux qui g√®rent la famille et mille choses.`, fun:`Team multit√¢ches ultime, respect üòÑ` },
        sportif:{ pro:`La discipline et les habitudes qui font progresser m‚Äôint√©ressent.`, neutre:`Les vibes sport/sant√©, j‚Äôaime bien.`, fun:`Team progression + bonne humeur üòÑ` },
        voyage:{ pro:`Les profils curieux et ouverts, surtout voyage, j‚Äôaime bien.`, neutre:`Voyage/lifestyle, √ßa donne envie de bouger.`, fun:`Ton contenu donne envie de prendre un billet üòÑ` },
        etudiant:{ pro:`J‚Äôaime bien √©changer avec des personnes en phase de construction.`, neutre:`J‚Äôaime bien connecter avec des gens qui d√©marrent.`, fun:`Grosse √©nergie ‚Äúje construis mon futur‚Äù üòÑ` },
        createur:{ pro:`Je respecte beaucoup la constance et la cr√©ativit√©.`, neutre:`On sent la patte chez les cr√©ateurs.`, fun:`Cr√©ateur = sport de haut niveau üòÑ` },
        job:{ pro:`√âchanger sur objectifs et √©volution pro, je trouve √ßa int√©ressant.`, neutre:`J‚Äôaime bien parler objectifs et organisation.`, fun:`Team ‚Äúon progresse sans se cramer‚Äù üòÑ` },
        indefini:{ pro:`Je suis partant pour un √©change simple et humain.`, neutre:`J‚Äôaime bien les √©changes simples, humains.`, fun:`Je passe pour la vibe, simple üòÑ` }
      };
      const b = map[persona] || map.indefini;
      return b[styleKey] || b.neutre;
    }

    function buildMessage(p) {
      const { prenom, plateforme, marche, objectif, style, lengthMode, persona, intention, accroche, centre, days } = p;
      const pack = tonePacks(style, plateforme, prenom);
      const styleKey = (style === "pro" ? "pro" : style === "fun" ? "fun" : "neutre");

      const introByRel = {
        froid: {
          pro:[`Je me permets de vous √©crire apr√®s √™tre tomb√© sur votre profil sur ${plateforme}.`,`Je d√©couvre votre profil sur ${plateforme} et je souhaitais vous saluer.`],
          neutre:[`Je te d√©couvre sur ${plateforme} et j‚Äôaime bien ton univers.`,`Je viens de voir ton contenu sur ${plateforme} et √ßa m‚Äôa donn√© envie de te parler.`],
          fun:[`Je viens de tomber sur ton profil sur ${plateforme} : l‚Äôalgorithme a bien boss√© üòÑ`,`Je passe par ${plateforme} et je me dis : ‚Äúok‚Ä¶ vibe int√©ressante ici.‚Äù`]
        },
        "ti√®de": {
          pro:[`Je reviens vers vous, je me disais que cela valait le coup de reprendre contact.`,`Petit message pour reprendre des nouvelles.`],
          neutre:[`Je repasse te dire bonjour üôÇ`,`Je me suis dit que √ßa valait le coup de reprendre contact.`],
          fun:[`Je reviens dans ta DM-zone üòÑ`,`Je repasse avant que l‚Äôalgorithme nous s√©pare üòÑ`]
        },
        chaud: {
          pro:[`J‚Äôesp√®re que vous allez bien. Je me permets de prendre des nouvelles.`,`Bonjour, je passais simplement prendre des nouvelles.`],
          neutre:[`Hey ${prenom}, j‚Äôesp√®re que tu vas bien üòä`,`Yo ${prenom} ! Petite pens√©e du jour üòÑ`],
          fun:[`Yo ${prenom} ! Comment va la l√©gende ? üòÑ`,`Petit check-up vibe du jour üëÄ`]
        }
      };

      const hook = accroche ? [`J‚Äôai vu ${accroche} ‚Äî √ßa m‚Äôa fait sourire.`,`Ton ${accroche} m‚Äôa intrigu√©.`] : [`Au fait, quoi de neuf en ce moment ?`,`Tu deviens quoi ces temps-ci ?`];
      const interest = centre ? [`Tu es toujours √† fond sur ${centre} ?`,`√áa avance tes trucs autour de ${centre} ?`] : [`Tu es sur quoi en ce moment ?`,`Qu‚Äôest-ce qui t‚Äôoccupe ces jours-ci ?`];

      const daysLine = (typeof days === "number")
        ? (days <= 3 ? (styleKey==="pro" ? `Nous avons √©chang√© r√©cemment, je me permets un petit message.` : `On s‚Äôest parl√© r√©cemment, je repasse vite fait.`)
           : days <= 10 ? (styleKey==="pro" ? `Je me permets de revenir vers vous apr√®s quelques jours.` : `√áa fait quelques jours, je me suis dit que je repassais.`)
           : (styleKey==="pro" ? `Cela fait un moment, je me permets de reprendre contact.` : `√áa fait un petit moment, je me disais que √ßa valait le coup.`))
        : null;

      const invitationSoft = {
        reseau: { pro:[`Si vous le souhaitez, on peut √©changer quelques minutes, simplement pour faire connaissance.`], neutre:[`Si √ßa te dit, on se cale 10 minutes pour papoter et faire connaissance.`], fun:[`On se cale 10 minutes ? Version papotage propre üòÑ`] },
        opportunite: {
          pro:[`J‚Äôai un sujet qui pourrait vous int√©resser. Si vous √™tes ouvert, on peut en parler 10 minutes, sans engagement.`,`J‚Äôai une id√©e/opportunit√© que je partage parfois √† des personnes qui ont votre profil. Si vous √™tes curieux, je vous explique.`],
          neutre:[`J‚Äôai un truc qui pourrait te plaire (rien d‚Äôagressif). Si t‚Äôes curieux, je t‚Äôexplique en 10 minutes.`,`J‚Äôai une id√©e/opportunit√© que je partage √† quelques personnes. Si √ßa t‚Äôintrigue, je peux t‚Äôen dire plus.`],
          fun:[`J‚Äôai un petit truc √† te partager. Pas un pitch de robot üòÑ Si t‚Äôes curieux, 10 minutes et c‚Äôest pli√©.`,`J‚Äôai une id√©e √† te proposer. Si tu dis ‚Äúpourquoi pas‚Äù, je t‚Äôexplique vite fait üòÑ`]
        },
        collab: { pro:[`Je pensais √† une possible collaboration/√©change d‚Äôid√©es. Si cela vous int√©resse, on peut en parler.`], neutre:[`Je me disais qu‚Äôon pourrait √©changer sur un projet / une collab possible.`], fun:[`Je sens une vibe ‚Äúcollab‚Äù possible üòÑ On en parle ?`] },
        curiosite: { pro:[`Je suis curieux d‚Äôen savoir plus sur ce que vous faites en ce moment.`], neutre:[`Je suis curieux : tu construis quoi en ce moment ?`], fun:[`Je suis curieux : tu build quoi en ce moment ? üòÑ`] }
      };

      const goal = {
        discussion: { pro:[`Je voulais simplement vous saluer.`], neutre:[`Je ne voulais pas passer sans te saluer üôÇ`], fun:[`Je passais dire bonjour, simple et efficace üòÑ`] },
        question:   { pro:[`Petite question : quel est votre focus du moment ?`], neutre:[`Question rapide : ton focus du moment, c‚Äôest quoi ?`], fun:[`Question flash ‚ö° : ton focus du moment, c‚Äôest quoi ?`] },
        invitation: invitationSoft[intention][styleKey],
        relance7:   { pro:[`Je me permets une relance, au cas o√π mon message vous aurait √©chapp√©.`], neutre:[`Petite relance üôÇ Tu avais eu le temps de voir mon message ?`], fun:[`Petit ping üõéÔ∏è : l‚Äôalgorithme a fait le ninja ou tu avais vu ? üòÑ`] }[styleKey],
        relance14:  { pro:[`Je reviens une derni√®re fois : si ce n‚Äôest pas le bon moment, aucun souci.`], neutre:[`Derni√®re relance üôÇ Si ce n‚Äôest pas le moment, aucun souci.`], fun:[`Dernier petit ping et apr√®s je disparais dans la fum√©e ü•∑üí®`] }[styleKey]
      };

      const intro = pick(introByRel[marche]?.[styleKey] || introByRel.froid.neutre);
      const personaTxt = personaLine(persona, styleKey);
      const goalLine = pick(goal[objectif] || goal.discussion.neutre);
      const outro = pick(pack.outro);

      const lines = [pick(pack.hello), ""];
      if (lengthMode === "court") {
        lines.push(intro, personaTxt, "", goalLine, "", outro);
        return lines.join("\n");
      }
      if (lengthMode === "normal") {
        lines.push(intro);
        (Math.random() < 0.5) ? lines.push(pick(hook), pick(interest)) : lines.push(pick(interest), pick(hook));
        lines.push(personaTxt);
        if (daysLine) lines.push(daysLine);
        lines.push("", goalLine, "", outro);
        return lines.join("\n");
      }
      const human = { pro:[`Rien d‚Äôurgent, c‚Äôest surtout pour garder un contact simple.`], neutre:[`Rien d‚Äôurgent, c‚Äôest juste pour garder le lien.`], fun:[`Promis, pas de script robot ici ü§ñ‚ùå`] };
      lines.push(intro, pick(hook), pick(interest), personaTxt);
      if (daysLine) lines.push(daysLine);
      lines.push(pick(human[styleKey]), "", goalLine, "", outro);
      return lines.join("\n");
    }

    function generate() {
      const prenom = clean($("prenom").value) || "toi";
      const plateforme = $("plateforme").value;
      const marche = $("marche").value;
      const objectif = $("objectif").value;
      const style = $("styleTone").value;
      const lengthMode = $("lengthMode").value;
      const persona = $("persona").value;
      const intention = $("intention").value;
      const accroche = clean($("accroche").value);
      const centre = clean($("centre").value);
      const days = daysSince($("dernier").value);

      const msg = buildMessage({ prenom, plateforme, marche, objectif, style, lengthMode, persona, intention, accroche, centre, days });
      $("result").value = msg;

      $("debug").textContent =
        `params => prenom:${prenom} | plateforme:${plateforme} | marche:${marche} | objectif:${objectif} | style:${style} | longueur:${lengthMode} | persona:${persona} | intention:${intention}`;

      $("daysInfo").textContent =
        (typeof days === "number") ? `Dernier contact : il y a ${days} jour(s).` : `Astuce : ajoute une date pour contextualiser.`;
    }

    // --------- contacts (local) ---------
    function migrateContact(raw) {
      const c = { ...(raw || {}) };
      if (!c.marche && c.relation) c.marche = c.relation;
      if (!c.marche) c.marche = "froid";
      if (!c.relation_type) c.relation_type = "prospect";
      c.telephone = normalizePhone(c.telephone || "");
      c.email = normalizeEmail(c.email || "");
      return c;
    }

    function loadContacts() {
      try {
        const parsed = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        return Array.isArray(parsed) ? parsed.map(migrateContact) : [];
      }
      catch { return []; }
    }
    function saveContacts(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    function normalizeKeyPart(value) {
      return clean(value)
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function contactKey(c) {
      return `${normalizeKeyPart(c.prenom)}__${normalizeKeyPart(c.plateforme)}`;
    }

    function getContactByKey(list, key) {
      return list.find((c) => contactKey(c) === key);
    }

    function getFormAsContact() {
      return {
        prenom: clean($("prenom").value),
        plateforme: $("plateforme").value,
        marche: $("marche").value,
        relation_type: $("relation_type").value,
        telephone: normalizePhone($("telephone").value),
        email: normalizeEmail($("email").value),
        objectif: $("objectif").value,
        style: $("styleTone").value,
        longueur: $("lengthMode").value,
        persona: $("persona").value,
        intention: $("intention").value,
        statut: $("statut").value,
        date_creation: $("dateCreation").value || "",
        dernier: $("dernier").value || "",
        prochaine_relance: $("prochaine").value || "",
        centre: clean($("centre").value),
        accroche: clean($("accroche").value),
        note: clean($("note").value)
      };
    }

    function updateContactInfoAndCopyButtons(c) {
      const info = $("contactInfo");
      const tel = c?.telephone || "";
      const email = c?.email || "";
      info.textContent = c ? `T√©l√©phone : ${tel || "‚Äî"}\nEmail : ${email || "‚Äî"}` : "";
      $("btnCopyPhone").disabled = !tel;
      $("btnCopyEmail").disabled = !email;
    }

    function computeNextFollowUp(c) {
      if (c.statut !== "√Ä relancer") return c.prochaine_relance || "";
      const base = c.dernier || todayISO();
      if (c.objectif === "relance14") return addDaysISO(base, 14);
      return addDaysISO(base, 7);
    }

    function fillFormFromContact(c) {
      selectedKey = contactKey(c);
      const select = $("contactSelect");
      if (select) select.value = selectedKey;

      $("prenom").value = c.prenom || "";
      $("plateforme").value = c.plateforme || "Instagram";
      $("marche").value = c.marche || "froid";
      $("relation_type").value = c.relation_type || "prospect";
      $("objectif").value = c.objectif || "discussion";
      $("styleTone").value = c.style || "neutre";
      $("lengthMode").value = c.longueur || "normal";
      $("persona").value = c.persona || "indefini";
      $("intention").value = c.intention || "reseau";
      $("statut").value = c.statut || "Nouveau";
      $("dateCreation").value = c.date_creation || "";
      $("dernier").value = c.dernier || "";
      $("prochaine").value = c.prochaine_relance || "";
      $("centre").value = c.centre || "";
      $("accroche").value = c.accroche || "";
      $("note").value = c.note || "";
      $("telephone").value = c.telephone || "";
      $("email").value = c.email || "";
      updateContactInfoAndCopyButtons(c);
      generate();
    }

    function isUrgent(c, today) {
      return c.statut === "√Ä relancer" && c.prochaine_relance && c.prochaine_relance <= today;
    }

    function matchesFilter(c, filterValue, today) {
      if (filterValue === "urgent") return isUrgent(c, today);
      if (filterValue === "relance") return c.statut === "√Ä relancer";
      if (filterValue === "rdv") return c.statut === "RDV pris";
      return true;
    }

    function matchesSearch(c, query) {
      if (!query) return true;
      const haystack = `${c.prenom || ""} ${c.note || ""} ${c.plateforme || ""}`.toLowerCase();
      return haystack.includes(query);
    }

    function refreshUI() {
      const contacts = loadContacts();
      const today = todayISO();
      const filterValue = $("filterSelect").value;
      const searchValue = clean($("searchInput").value).toLowerCase();

      const sel = $("contactSelect");
      sel.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = ""; o0.textContent = "‚Äî s√©lectionner ‚Äî";
      sel.appendChild(o0);

      contacts
        .slice()
        .sort((a,b)=> (a.prenom||"").localeCompare(b.prenom||""))
        .forEach((c) => {
          const o = document.createElement("option");
          o.value = contactKey(c);
          o.textContent = `${c.prenom || "(sans pr√©nom)"} ‚Ä¢ ${c.plateforme || ""}`;
          sel.appendChild(o);
        });

      if (selectedKey && getContactByKey(contacts, selectedKey)) {
        sel.value = selectedKey;
      } else {
        selectedKey = "";
        sel.value = "";
      }

      const relanceCount = contacts.filter((c) => isUrgent(c, today)).length;
      const totalToFollow = contacts.filter((c) => c.statut === "√Ä relancer").length;
      $("relanceCount").textContent = `Relances du jour : ${relanceCount} / Total √† relancer : ${totalToFollow}`;

      const contactsForDisplay = contacts
        .filter((c) => matchesFilter(c, filterValue, today))
        .filter((c) => matchesSearch(c, searchValue))
        .slice()
        .sort((a, b) => {
          const urgentA = isUrgent(a, today) ? 0 : 1;
          const urgentB = isUrgent(b, today) ? 0 : 1;
          if (urgentA !== urgentB) return urgentA - urgentB;
          const da = a.prochaine_relance || "";
          const db = b.prochaine_relance || "";
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da.localeCompare(db);
        });

      const tbody = $("contactTableBody");
      tbody.innerHTML = "";

      contactsForDisplay.forEach((c) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.title = "Clique pour charger ce contact";
        tr.addEventListener("click", () => {
          selectedKey = contactKey(c);
          $("contactSelect").value = selectedKey;
          fillFormFromContact(c);
        });

        const td1 = document.createElement("td"); td1.textContent = c.prenom || "";
        const td2 = document.createElement("td"); td2.textContent = c.plateforme || "";

        const td3 = document.createElement("td");
        td3.textContent = c.statut || "";
        if (isUrgent(c, today)) {
          const badge = document.createElement("span");
          badge.className = "badge-urgent";
          badge.textContent = "URGENT";
          td3.append(" ", badge);
        }

        const td4 = document.createElement("td");
        td4.textContent = c.prochaine_relance ? `${c.prochaine_relance}${formatFollowUpSuffix(c.prochaine_relance)}` : "";

        const td5 = document.createElement("td"); td5.textContent = c.note || "";

        tr.append(td1, td2, td3, td4, td5);
        tbody.appendChild(tr);
      });
    }

    function addOrUpdateContact() {
      const c = getFormAsContact();
      if (!c.prenom) { alert("Ajoute au moins un pr√©nom pour enregistrer üôÇ"); return; }
      if (c.email && !isValidEmail(c.email)) {
        alert("Email invalide : merci de v√©rifier le format (ex: nom@domaine.com).");
        return;
      }

      const contacts = loadContacts();
      const key = contactKey(c);
      const i = contacts.findIndex(x => contactKey(x) === key);

      if (i < 0 && !c.date_creation) c.date_creation = todayISO();
      c.prochaine_relance = computeNextFollowUp(c);

      $("dateCreation").value = c.date_creation;
      $("prochaine").value = c.prochaine_relance;

      if (i >= 0) contacts[i] = c; else contacts.push(c);
      saveContacts(contacts);

      selectedKey = key;
      refreshUI();
      updateContactInfoAndCopyButtons(c);
    }

    function deleteSelectedContact() {
      const key = $("contactSelect").value || selectedKey;
      if (!key) return;

      const contacts = loadContacts();
      const i = contacts.findIndex((c) => contactKey(c) === key);
      if (i < 0) return;

      const name = contacts[i]?.prenom || "ce contact";
      if (!confirm(`Supprimer ${name} ?`)) return;

      contacts.splice(i, 1);
      saveContacts(contacts);

      if (selectedKey === key) selectedKey = "";
      refreshUI();
      updateContactInfoAndCopyButtons(null);
    }

    function updateSelectedContact(updateFn) {
      const key = $("contactSelect").value || selectedKey;
      if (!key) { alert("S√©lectionne un contact d‚Äôabord."); return; }
      const contacts = loadContacts();
      const i = contacts.findIndex((c) => contactKey(c) === key);
      if (i < 0) return;

      const updated = { ...contacts[i] };
      updateFn(updated);
      contacts[i] = updated;
      saveContacts(contacts);
      selectedKey = key;
      refreshUI();
    }

    function markAsReplied() {
      updateSelectedContact((c) => {
        c.statut = "R√©pondu";
        c.dernier = todayISO();
        c.prochaine_relance = "";
      });
    }

    function planFollowUp(days, objectif) {
      updateSelectedContact((c) => {
        c.statut = "√Ä relancer";
        c.objectif = objectif;
        const base = c.dernier || todayISO();
        if (!c.dernier) c.dernier = base;
        c.prochaine_relance = addDaysISO(base, days);
      });
    }

    // --------- CSV ---------
    const CSV_HEADERS = ["prenom","plateforme","marche","relation_type","telephone","email","objectif","style","longueur","persona","intention","statut","date_creation","dernier","prochaine_relance","centre","accroche","note"];

    function escapeCSV(value) {
      const s = String(value ?? "");
      if (/[",\n\r;]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function toCSVRow(obj) {
      return CSV_HEADERS.map(h => escapeCSV(obj[h] ?? "")).join(",");
    }

    function exportCSV() {
      const contacts = loadContacts();
      const lines = [CSV_HEADERS.join(",")];
      contacts.forEach(c => lines.push(toCSVRow(c)));
      const csv = lines.join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "contacts_mlm.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function parseCSV(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            const next = text[i+1];
            if (next === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += ch; i++; continue;
        } else {
          if (ch === '"') { inQuotes = true; i++; continue; }
          if (ch === ',') { row.push(field); field=""; i++; continue; }
          if (ch === '\n') { row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
          if (ch === '\r') { i++; continue; }
          field += ch; i++; continue;
        }
      }
      row.push(field); rows.push(row);
      return rows;
    }

    function importCSVFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        if (rows.length < 1) { alert("CSV vide."); return; }

        const headers = rows[0].map(h => h.trim());
        const map = {};
        headers.forEach((h, idx) => map[h] = idx);

        if (map["prenom"] == null) { alert("CSV invalide : colonne 'prenom' introuvable."); return; }

        const imported = [];
        for (let r = 1; r < rows.length; r++) {
          const line = rows[r];
          if (line.length === 1 && !line[0]) continue;

          const obj = {};
          CSV_HEADERS.forEach(h => {
            const idx = map[h];
            obj[h] = (idx != null && idx < line.length) ? (line[idx] || "") : "";
          });

          if (!obj.plateforme) obj.plateforme = "Instagram";
          if (!obj.marche && obj.relation) obj.marche = obj.relation;
          if (!obj.marche) obj.marche = "froid";
          if (!obj.relation_type) obj.relation_type = "prospect";
          obj.telephone = normalizePhone(obj.telephone || "");
          obj.email = normalizeEmail(obj.email || "");
          if (!obj.objectif) obj.objectif = "discussion";
          if (!obj.style) obj.style = "neutre";
          if (!obj.longueur) obj.longueur = "normal";
          if (!obj.persona) obj.persona = "indefini";
          if (!obj.intention) obj.intention = "reseau";
          if (!obj.statut) obj.statut = "Nouveau";
          if (!obj.date_creation) obj.date_creation = todayISO();

          if (obj.statut === "√Ä relancer" && !obj.prochaine_relance) {
            obj.prochaine_relance = computeNextFollowUp(obj);
          }

          if (clean(obj.prenom)) imported.push(obj);
        }

        const contacts = loadContacts();
        imported.forEach(c => {
          const key = contactKey(c);
          const i = contacts.findIndex(x => contactKey(x) === key);
          if (i >= 0) contacts[i] = c; else contacts.push(c);
        });

        saveContacts(contacts);
        refreshUI();
        alert(`Import termin√© ‚úÖ (${imported.length} contact(s))`);
      };
      reader.readAsText(file, "utf-8");
    }

    // --------- events ---------
    warnDuplicateIds();

    function copyWithFeedback(btnId, value, defaultLabel) {
      if (!value) return;
      navigator.clipboard.writeText(value)
        .then(() => {
          $(btnId).textContent = "Copi√© ‚úÖ";
          setTimeout(() => { $(btnId).textContent = defaultLabel; }, 900);
        })
        .catch(() => {
          alert("Copie impossible. Copie manuelle requise.");
        });
    }

    addListenerOnce("btnGen", "click", generate);
    addListenerOnce("btnRandom", "click", generate);

    addListenerOnce("btnCopy", "click", async function onCopyMessage() {
      const text = $("result").value;
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        $("btnCopy").textContent = "Copi√© ‚úÖ";
        setTimeout(() => $("btnCopy").textContent = "Copier", 900);
      } catch {
        alert("Copie impossible. S√©lectionne le texte et fais Ctrl+C.");
      }
    });

    addListenerOnce("btnCopyPhone", "click", function onCopyPhone() {
      copyWithFeedback("btnCopyPhone", $("telephone").value, "Copier tel");
    });

    addListenerOnce("btnCopyEmail", "click", function onCopyEmail() {
      copyWithFeedback("btnCopyEmail", $("email").value, "Copier email");
    });

    addListenerOnce("btnClear", "click", function onClear() {
      ["prenom","centre","accroche","note","dernier","prochaine","telephone","email"].forEach(id => $(id).value = "");
      $("dateCreation").value = "";
      $("plateforme").value = "Instagram";
      $("marche").value = "froid";
      $("relation_type").value = "prospect";
      $("objectif").value = "discussion";
      $("styleTone").value = "neutre";
      $("lengthMode").value = "normal";
      $("persona").value = "indefini";
      $("intention").value = "reseau";
      $("statut").value = "√Ä relancer";
      $("result").value = "";
      $("debug").textContent = "";
      $("daysInfo").textContent = "";
      selectedKey = "";
      updateContactInfoAndCopyButtons(null);
      generate();
      refreshUI();
    });

    addListenerOnce("btnAdd", "click", addOrUpdateContact);
    addListenerOnce("btnDelete", "click", deleteSelectedContact);
    addListenerOnce("btnMarkReplied", "click", markAsReplied);
    addListenerOnce("btnPlan7", "click", function onPlan7() { planFollowUp(7, "relance7"); });
    addListenerOnce("btnPlan14", "click", function onPlan14() { planFollowUp(14, "relance14"); });

    addListenerOnce("contactSelect", "change", function onContactSelectChange() {
      const contacts = loadContacts();
      selectedKey = $("contactSelect").value;
      if (!selectedKey) {
        updateContactInfoAndCopyButtons(null);
        return;
      }
      const found = getContactByKey(contacts, selectedKey);
      if (!found) return;
      fillFormFromContact(found);
    });

    addListenerOnce("telephone", "input", function onPhoneInput() { updateContactInfoAndCopyButtons(getFormAsContact()); });
    addListenerOnce("email", "input", function onEmailInput() { updateContactInfoAndCopyButtons(getFormAsContact()); });

    addListenerOnce("filterSelect", "change", refreshUI);
    addListenerOnce("searchInput", "input", refreshUI);

    addListenerOnce("btnExport", "click", exportCSV);
    addListenerOnce("btnImportBtn", "click", function onImportClick() { $("importFile").click(); });
    addListenerOnce("importFile", "change", function onImportChange(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      importCSVFile(file);
      e.target.value = "";
    });

    // Auto recalcul si tu changes (statut/objectif/dernier)
    function autoSuggestNext() {
      const statut = $("statut").value;
      if (statut !== "√Ä relancer") return;
      const base = $("dernier").value || todayISO();
      const obj = $("objectif").value;
      const next = (obj === "relance14") ? addDaysISO(base, 14) : addDaysISO(base, 7);
      $("prochaine").value = next;
    }
    addListenerOnce("statut", "change", autoSuggestNext);
    addListenerOnce("objectif", "change", autoSuggestNext);
    addListenerOnce("dernier", "change", autoSuggestNext);

    // init
    refreshUI();
    generate();
    autoSuggestNext();
    updateContactInfoAndCopyButtons(null);
  </script>
</body>
</html>
