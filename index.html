<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÃ©nÃ©rateur + mini CRM (CSV+statuts)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1250px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    p { margin: 0 0 14px; color: #444; }
    .grid { display: grid; grid-template-columns: 1.15fr 0.85fr; gap: 12px; }
    .card { background:#fafafa; border:1px solid #eee; border-radius:16px; padding:14px; }
    label { display:block; font-weight:700; margin: 10px 0 6px; }
    input, select, textarea, button {
      width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; font-size:14px;
    }
    textarea { min-height:160px; resize: vertical; }
    button { cursor:pointer; border:none; background:#1f7a5b; color:#fff; font-weight:800; }
    button.secondary { background:#444; }
    button.ghost { background:#eaeaea; color:#222; border:1px solid #ddd; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .small { font-size:12px; color:#666; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e9f5ef; border:1px solid #cfe8dd; font-size:12px; color:#185a43; }
    table { width:100%; border-collapse: collapse; margin-top:10px; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { border-bottom:1px solid #eee; padding:8px; font-size:13px; text-align:left; vertical-align:top; }
    th { background:#f3f3f3; }
    tr:hover { background:#fbfbfb; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .inline > * { flex: 1; min-width: 180px; }
    .badge-urgent { display:inline-block; padding:2px 8px; border-radius:999px; background:#ffe1e1; color:#8b1d1d; border:1px solid #f1bcbc; font-size:11px; font-weight:700; }
  </style>
</head>
<body>
  <h1>GÃ©nÃ©rateur de messages + mini CRM</h1>
  <p>
    <span class="pill">CSV + statuts + relances auto</span> â€¢ gratuit â€¢ fonctionne partout
  </p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row3">
        <div>
          <label for="prenom">PrÃ©nom</label>
          <input id="prenom" placeholder="Ex: Julie" />
        </div>
        <div>
          <label for="plateforme">Plateforme</label>
          <select id="plateforme">
            <option>Instagram</option>
            <option>Facebook</option>
            <option>TikTok</option>
            <option>LinkedIn</option>
            <option>WhatsApp</option>
          </select>
        </div>
        <div>
          <label for="relation">Relation</label>
          <select id="relation">
            <option value="froid">Froid</option>
            <option value="tiÃ¨de">TiÃ¨de</option>
            <option value="chaud">Chaud</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label for="objectif">Objectif</label>
          <select id="objectif">
            <option value="discussion">Discussion</option>
            <option value="question">Question</option>
            <option value="invitation">Invitation</option>
            <option value="relance7">Relance J+7</option>
            <option value="relance14">Relance J+14</option>
          </select>
        </div>

        <div>
          <label for="styleTone">Style</label>
          <select id="styleTone">
            <option value="neutre">Neutre</option>
            <option value="pro">Pro</option>
            <option value="fun">Fun</option>
          </select>
        </div>

        <div>
          <label for="lengthMode">Longueur</label>
          <select id="lengthMode">
            <option value="court">Court</option>
            <option value="normal" selected>Normal</option>
            <option value="long">Long</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label for="persona">Type de personne</label>
          <select id="persona">
            <option value="entrepreneur">Entrepreneur / business</option>
            <option value="parent">Parent / famille</option>
            <option value="sportif">Sportif / santÃ©</option>
            <option value="voyage">Voyage / lifestyle</option>
            <option value="etudiant">Ã‰tudiant / dÃ©but de carriÃ¨re</option>
            <option value="createur">CrÃ©ateur / contenu</option>
            <option value="job">SalariÃ© / carriÃ¨re</option>
            <option value="indefini" selected>IndÃ©fini</option>
          </select>
        </div>

        <div>
          <label for="intention">Intention</label>
          <select id="intention">
            <option value="reseau" selected>RÃ©seau / discuter</option>
            <option value="opportunite">OpportunitÃ© (soft)</option>
            <option value="collab">Collab / projet</option>
            <option value="curiosite">CuriositÃ© / apprendre</option>
          </select>
        </div>

        <div>
          <label for="statut">Statut</label>
          <select id="statut">
            <option value="Nouveau">Nouveau</option>
            <option value="RÃ©pondu">RÃ©pondu</option>
            <option value="Ã€ relancer" selected>Ã€ relancer</option>
            <option value="RDV pris">RDV pris</option>
            <option value="Ã€ ne plus contacter">Ã€ ne plus contacter</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="dernier">Dernier contact</label>
          <input id="dernier" type="date" />
          <div class="small">Optionnel : sert au contexte du message.</div>
        </div>
        <div>
          <label for="prochaine">Prochaine relance</label>
          <input id="prochaine" type="date" />
          <div class="small">Peut Ãªtre auto-remplie quand tu â€œAjoutes/MAJâ€.</div>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="centre">Centres dâ€™intÃ©rÃªt</label>
          <input id="centre" placeholder="Ex: sport, voyage..." />
        </div>
        <div>
          <label for="dateCreation">Date crÃ©ation</label>
          <input id="dateCreation" type="date" disabled />
          <div class="small">Automatique Ã  la premiÃ¨re sauvegarde.</div>
        </div>
      </div>

      <label for="accroche">Accroche / contexte</label>
      <input id="accroche" placeholder="Ex: ta story / ton post..." />

      <label for="note">Note (CRM)</label>
      <input id="note" placeholder="Ex: aime voyager, relance mardi, etc." />

      <div class="actions">
        <button id="btnGen">GÃ©nÃ©rer</button>
        <button class="ghost" id="btnRandom">ğŸ² Variante</button>
        <button class="ghost" id="btnCopy">Copier</button>
        <button class="secondary" id="btnClear">Effacer</button>
      </div>

      <div class="small" id="daysInfo"></div>

      <label for="result">Message gÃ©nÃ©rÃ©</label>
      <textarea id="result" readonly></textarea>

      <div class="small mono" id="debug" style="margin-top:8px;"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="inline">
        <div>
          <label for="contactSelect">Contacts</label>
          <select id="contactSelect"></select>
          <div class="small">SÃ©lectionne â†’ Ã§a remplit le formulaire.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="ghost" id="btnAdd">+ Ajouter/Mettre Ã  jour</button>
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnMarkReplied">Marquer comme RÃ©pondu</button>
        <button class="ghost" id="btnPlan7">Planifier relance J+7</button>
        <button class="ghost" id="btnPlan14">Planifier relance J+14</button>
      </div>

      <div class="actions">
        <button class="ghost" id="btnExport">Exporter CSV</button>
        <button class="ghost" id="btnImportBtn">Importer CSV</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none;" />
        <button class="secondary" id="btnDelete">Supprimer contact</button>
      </div>

      <div class="small">
        Colonnes CSV :
        <span class="mono">prenom,plateforme,relation,objectif,style,longueur,persona,intention,statut,date_creation,dernier,prochaine_relance,centre,accroche,note</span>
      </div>

      <div class="row2">
        <div>
          <label for="filterSelect">Filtre</label>
          <select id="filterSelect">
            <option value="all">Tous</option>
            <option value="urgent">Urgent</option>
            <option value="relance">Ã€ relancer</option>
            <option value="rdv">RDV pris</option>
          </select>
        </div>
        <div>
          <label for="searchInput">Recherche</label>
          <input id="searchInput" placeholder="PrÃ©nom ou note..." />
        </div>
      </div>

      <div class="small" id="relanceCount" style="margin-top:8px;"></div>

      <table>
        <thead>
          <tr>
            <th>PrÃ©nom</th>
            <th>Plateforme</th>
            <th>Statut</th>
            <th>Prochaine relance</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="contactTableBody"></tbody>
      </table>

      <div class="small" style="margin-top:10px;">
        Astuce : â€œÃ€ relancerâ€ + Objectif = Relance J+7/J+14 â†’ calcule automatiquement la prochaine relance.
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clean = (s) => (s || "").trim();
    const STORAGE_KEY = "mlm_contacts_v2";
    let selectedKey = "";

    // --------- dates helpers ---------
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseISODate(iso) {
      if (!iso) return null;
      const d = new Date(`${iso}T00:00:00`);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function daysDiff(aISO, bISO) {
      const a = parseISODate(aISO);
      const b = parseISODate(bISO);
      if (!a || !b) return null;
      const diffMs = b.getTime() - a.getTime();
      return Math.round(diffMs / (1000 * 60 * 60 * 24));
    }

    function addDaysISO(baseISO, addDays) {
      const base = baseISO ? new Date(baseISO + "T00:00:00") : new Date();
      const d = new Date(base.getTime());
      d.setDate(d.getDate() + addDays);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function daysSince(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr + "T00:00:00");
      const now = new Date();
      const ms = now - d;
      if (isNaN(ms)) return null;
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function formatFollowUpSuffix(dateISO) {
      const diff = daysDiff(todayISO(), dateISO);
      if (diff == null) return "";
      if (diff === 0) return " (J+0)";
      if (diff > 0) return ` (J-${diff})`;
      return ` (J+${Math.abs(diff)})`;
    }

    // --------- message generator (same engine) ---------
    function tonePacks(style, plateforme, prenom) {
      const packs = {
        pro: { hello:[`Bonjour ${prenom},`,`Bonjour ${prenom} ğŸ‘‹`,`Hello ${prenom},`], outro:[`Bonne journÃ©e,`,`Au plaisir dâ€™Ã©changer,`,`Bien Ã  vous,`] },
        neutre: { hello:[`Salut ${prenom} !`,`Hello ${prenom} ğŸ‘‹`,`Coucou ${prenom} !`], outro:[`Bonne journÃ©e Ã  toi âœ¨`,`Ã€ bientÃ´t ğŸ™‚`,`Force Ã  toi ğŸ’ª`] },
        fun: { hello:[`Yo ${prenom} ğŸ˜„`,`Hey ${prenom} ğŸ‘‹`,`Coucou ${prenom} ğŸ˜„`], outro:[`Belle journÃ©e Ã  toi âœ¨`,`Ã€ trÃ¨s vite ğŸ˜„`,`Force & good vibes ğŸ’ª`], funWords:[`la jungle de ${plateforme}`,`le vortex des notifications`,`lâ€™algorithme farceur`] }
      };
      return packs[style] || packs.neutre;
    }

    function personaLine(persona, styleKey) {
      const map = {
        entrepreneur:{ pro:`Jâ€™aime bien Ã©changer avec des personnes orientÃ©es projets.`, neutre:`Jâ€™aime bien connecter avec des gens qui construisent des projets.`, fun:`Jâ€™aime les gens qui build des trucs ğŸ˜„` },
        parent:{ pro:`Ã‰changer avec des personnes qui jonglent avec la vie de famille, câ€™est toujours intÃ©ressant.`, neutre:`Respect Ã  ceux qui gÃ¨rent la famille et mille choses.`, fun:`Team multitÃ¢ches ultime, respect ğŸ˜„` },
        sportif:{ pro:`La discipline et les habitudes qui font progresser mâ€™intÃ©ressent.`, neutre:`Les vibes sport/santÃ©, jâ€™aime bien.`, fun:`Team progression + bonne humeur ğŸ˜„` },
        voyage:{ pro:`Les profils curieux et ouverts, surtout voyage, jâ€™aime bien.`, neutre:`Voyage/lifestyle, Ã§a donne envie de bouger.`, fun:`Ton contenu donne envie de prendre un billet ğŸ˜„` },
        etudiant:{ pro:`Jâ€™aime bien Ã©changer avec des personnes en phase de construction.`, neutre:`Jâ€™aime bien connecter avec des gens qui dÃ©marrent.`, fun:`Grosse Ã©nergie â€œje construis mon futurâ€ ğŸ˜„` },
        createur:{ pro:`Je respecte beaucoup la constance et la crÃ©ativitÃ©.`, neutre:`On sent la patte chez les crÃ©ateurs.`, fun:`CrÃ©ateur = sport de haut niveau ğŸ˜„` },
        job:{ pro:`Ã‰changer sur objectifs et Ã©volution pro, je trouve Ã§a intÃ©ressant.`, neutre:`Jâ€™aime bien parler objectifs et organisation.`, fun:`Team â€œon progresse sans se cramerâ€ ğŸ˜„` },
        indefini:{ pro:`Je suis partant pour un Ã©change simple et humain.`, neutre:`Jâ€™aime bien les Ã©changes simples, humains.`, fun:`Je passe pour la vibe, simple ğŸ˜„` }
      };
      const b = map[persona] || map.indefini;
      return b[styleKey] || b.neutre;
    }

    function buildMessage(p) {
      const { prenom, plateforme, relation, objectif, style, lengthMode, persona, intention, accroche, centre, days } = p;
      const pack = tonePacks(style, plateforme, prenom);
      const styleKey = (style === "pro" ? "pro" : style === "fun" ? "fun" : "neutre");

      const introByRel = {
        froid: {
          pro:[`Je me permets de vous Ã©crire aprÃ¨s Ãªtre tombÃ© sur votre profil sur ${plateforme}.`,`Je dÃ©couvre votre profil sur ${plateforme} et je souhaitais vous saluer.`],
          neutre:[`Je te dÃ©couvre sur ${plateforme} et jâ€™aime bien ton univers.`,`Je viens de voir ton contenu sur ${plateforme} et Ã§a mâ€™a donnÃ© envie de te parler.`],
          fun:[`Je viens de tomber sur ton profil sur ${plateforme} : lâ€™algorithme a bien bossÃ© ğŸ˜„`,`Je passe par ${plateforme} et je me dis : â€œokâ€¦ vibe intÃ©ressante ici.â€`]
        },
        "tiÃ¨de": {
          pro:[`Je reviens vers vous, je me disais que cela valait le coup de reprendre contact.`,`Petit message pour reprendre des nouvelles.`],
          neutre:[`Je repasse te dire bonjour ğŸ™‚`,`Je me suis dit que Ã§a valait le coup de reprendre contact.`],
          fun:[`Je reviens dans ta DM-zone ğŸ˜„`,`Je repasse avant que lâ€™algorithme nous sÃ©pare ğŸ˜„`]
        },
        chaud: {
          pro:[`Jâ€™espÃ¨re que vous allez bien. Je me permets de prendre des nouvelles.`,`Bonjour, je passais simplement prendre des nouvelles.`],
          neutre:[`Hey ${prenom}, jâ€™espÃ¨re que tu vas bien ğŸ˜Š`,`Yo ${prenom} ! Petite pensÃ©e du jour ğŸ˜„`],
          fun:[`Yo ${prenom} ! Comment va la lÃ©gende ? ğŸ˜„`,`Petit check-up vibe du jour ğŸ‘€`]
        }
      };

      const hook = accroche ? [`Jâ€™ai vu ${accroche} â€” Ã§a mâ€™a fait sourire.`,`Ton ${accroche} mâ€™a intriguÃ©.`] : [`Au fait, quoi de neuf en ce moment ?`,`Tu deviens quoi ces temps-ci ?`];
      const interest = centre ? [`Tu es toujours Ã  fond sur ${centre} ?`,`Ã‡a avance tes trucs autour de ${centre} ?`] : [`Tu es sur quoi en ce moment ?`,`Quâ€™est-ce qui tâ€™occupe ces jours-ci ?`];

      const daysLine = (typeof days === "number")
        ? (days <= 3 ? (styleKey==="pro" ? `Nous avons Ã©changÃ© rÃ©cemment, je me permets un petit message.` : `On sâ€™est parlÃ© rÃ©cemment, je repasse vite fait.`)
           : days <= 10 ? (styleKey==="pro" ? `Je me permets de revenir vers vous aprÃ¨s quelques jours.` : `Ã‡a fait quelques jours, je me suis dit que je repassais.`)
           : (styleKey==="pro" ? `Cela fait un moment, je me permets de reprendre contact.` : `Ã‡a fait un petit moment, je me disais que Ã§a valait le coup.`))
        : null;

      const invitationSoft = {
        reseau: { pro:[`Si vous le souhaitez, on peut Ã©changer quelques minutes, simplement pour faire connaissance.`], neutre:[`Si Ã§a te dit, on se cale 10 minutes pour papoter et faire connaissance.`], fun:[`On se cale 10 minutes ? Version papotage propre ğŸ˜„`] },
        opportunite: {
          pro:[`Jâ€™ai un sujet qui pourrait vous intÃ©resser. Si vous Ãªtes ouvert, on peut en parler 10 minutes, sans engagement.`,`Jâ€™ai une idÃ©e/opportunitÃ© que je partage parfois Ã  des personnes qui ont votre profil. Si vous Ãªtes curieux, je vous explique.`],
          neutre:[`Jâ€™ai un truc qui pourrait te plaire (rien dâ€™agressif). Si tâ€™es curieux, je tâ€™explique en 10 minutes.`,`Jâ€™ai une idÃ©e/opportunitÃ© que je partage Ã  quelques personnes. Si Ã§a tâ€™intrigue, je peux tâ€™en dire plus.`],
          fun:[`Jâ€™ai un petit truc Ã  te partager. Pas un pitch de robot ğŸ˜„ Si tâ€™es curieux, 10 minutes et câ€™est pliÃ©.`,`Jâ€™ai une idÃ©e Ã  te proposer. Si tu dis â€œpourquoi pasâ€, je tâ€™explique vite fait ğŸ˜„`]
        },
        collab: { pro:[`Je pensais Ã  une possible collaboration/Ã©change dâ€™idÃ©es. Si cela vous intÃ©resse, on peut en parler.`], neutre:[`Je me disais quâ€™on pourrait Ã©changer sur un projet / une collab possible.`], fun:[`Je sens une vibe â€œcollabâ€ possible ğŸ˜„ On en parle ?`] },
        curiosite: { pro:[`Je suis curieux dâ€™en savoir plus sur ce que vous faites en ce moment.`], neutre:[`Je suis curieux : tu construis quoi en ce moment ?`], fun:[`Je suis curieux : tu build quoi en ce moment ? ğŸ˜„`] }
      };

      const goal = {
        discussion: { pro:[`Je voulais simplement vous saluer.`], neutre:[`Je ne voulais pas passer sans te saluer ğŸ™‚`], fun:[`Je passais dire bonjour, simple et efficace ğŸ˜„`] },
        question:   { pro:[`Petite question : quel est votre focus du moment ?`], neutre:[`Question rapide : ton focus du moment, câ€™est quoi ?`], fun:[`Question flash âš¡ : ton focus du moment, câ€™est quoi ?`] },
        invitation: invitationSoft[intention][styleKey],
        relance7:   { pro:[`Je me permets une relance, au cas oÃ¹ mon message vous aurait Ã©chappÃ©.`], neutre:[`Petite relance ğŸ™‚ Tu avais eu le temps de voir mon message ?`], fun:[`Petit ping ğŸ›ï¸ : lâ€™algorithme a fait le ninja ou tu avais vu ? ğŸ˜„`] }[styleKey],
        relance14:  { pro:[`Je reviens une derniÃ¨re fois : si ce nâ€™est pas le bon moment, aucun souci.`], neutre:[`DerniÃ¨re relance ğŸ™‚ Si ce nâ€™est pas le moment, aucun souci.`], fun:[`Dernier petit ping et aprÃ¨s je disparais dans la fumÃ©e ğŸ¥·ğŸ’¨`] }[styleKey]
      };

      const intro = pick(introByRel[relation]?.[styleKey] || introByRel.froid.neutre);
      const personaTxt = personaLine(persona, styleKey);
      const goalLine = pick(goal[objectif] || goal.discussion.neutre);
      const outro = pick(pack.outro);

      const lines = [pick(pack.hello), ""];
      if (lengthMode === "court") {
        lines.push(intro, personaTxt, "", goalLine, "", outro);
        return lines.join("\n");
      }
      if (lengthMode === "normal") {
        lines.push(intro);
        (Math.random() < 0.5) ? lines.push(pick(hook), pick(interest)) : lines.push(pick(interest), pick(hook));
        lines.push(personaTxt);
        if (daysLine) lines.push(daysLine);
        lines.push("", goalLine, "", outro);
        return lines.join("\n");
      }
      const human = { pro:[`Rien dâ€™urgent, câ€™est surtout pour garder un contact simple.`], neutre:[`Rien dâ€™urgent, câ€™est juste pour garder le lien.`], fun:[`Promis, pas de script robot ici ğŸ¤–âŒ`] };
      lines.push(intro, pick(hook), pick(interest), personaTxt);
      if (daysLine) lines.push(daysLine);
      lines.push(pick(human[styleKey]), "", goalLine, "", outro);
      return lines.join("\n");
    }

    function generate() {
      const prenom = clean($("prenom").value) || "toi";
      const plateforme = $("plateforme").value;
      const relation = $("relation").value;
      const objectif = $("objectif").value;
      const style = $("styleTone").value;
      const lengthMode = $("lengthMode").value;
      const persona = $("persona").value;
      const intention = $("intention").value;
      const accroche = clean($("accroche").value);
      const centre = clean($("centre").value);
      const days = daysSince($("dernier").value);

      const msg = buildMessage({ prenom, plateforme, relation, objectif, style, lengthMode, persona, intention, accroche, centre, days });
      $("result").value = msg;

      $("debug").textContent =
        `params => prenom:${prenom} | plateforme:${plateforme} | relation:${relation} | objectif:${objectif} | style:${style} | longueur:${lengthMode} | persona:${persona} | intention:${intention}`;

      $("daysInfo").textContent =
        (typeof days === "number") ? `Dernier contact : il y a ${days} jour(s).` : `Astuce : ajoute une date pour contextualiser.`;
    }

    // --------- contacts (local) ---------
    function loadContacts() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveContacts(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    function normalizeKeyPart(value) {
      return clean(value)
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function contactKey(c) {
      return `${normalizeKeyPart(c.prenom)}__${normalizeKeyPart(c.plateforme)}`;
    }

    function getContactByKey(list, key) {
      return list.find((c) => contactKey(c) === key);
    }

    function getFormAsContact() {
      return {
        prenom: clean($("prenom").value),
        plateforme: $("plateforme").value,
        relation: $("relation").value,
        objectif: $("objectif").value,
        style: $("styleTone").value,
        longueur: $("lengthMode").value,
        persona: $("persona").value,
        intention: $("intention").value,
        statut: $("statut").value,
        date_creation: $("dateCreation").value || "",
        dernier: $("dernier").value || "",
        prochaine_relance: $("prochaine").value || "",
        centre: clean($("centre").value),
        accroche: clean($("accroche").value),
        note: clean($("note").value)
      };
    }

    function computeNextFollowUp(c) {
      if (c.statut !== "Ã€ relancer") return c.prochaine_relance || "";
      const base = c.dernier || todayISO();
      if (c.objectif === "relance14") return addDaysISO(base, 14);
      return addDaysISO(base, 7);
    }

    function fillFormFromContact(c) {
      selectedKey = contactKey(c);
      const select = $("contactSelect");
      if (select) select.value = selectedKey;

      $("prenom").value = c.prenom || "";
      $("plateforme").value = c.plateforme || "Instagram";
      $("relation").value = c.relation || "froid";
      $("objectif").value = c.objectif || "discussion";
      $("styleTone").value = c.style || "neutre";
      $("lengthMode").value = c.longueur || "normal";
      $("persona").value = c.persona || "indefini";
      $("intention").value = c.intention || "reseau";
      $("statut").value = c.statut || "Nouveau";
      $("dateCreation").value = c.date_creation || "";
      $("dernier").value = c.dernier || "";
      $("prochaine").value = c.prochaine_relance || "";
      $("centre").value = c.centre || "";
      $("accroche").value = c.accroche || "";
      $("note").value = c.note || "";
      generate();
    }

    function isUrgent(c, today) {
      return c.statut === "Ã€ relancer" && c.prochaine_relance && c.prochaine_relance <= today;
    }

    function matchesFilter(c, filterValue, today) {
      if (filterValue === "urgent") return isUrgent(c, today);
      if (filterValue === "relance") return c.statut === "Ã€ relancer";
      if (filterValue === "rdv") return c.statut === "RDV pris";
      return true;
    }

    function matchesSearch(c, query) {
      if (!query) return true;
      const haystack = `${c.prenom || ""} ${c.note || ""} ${c.plateforme || ""}`.toLowerCase();
      return haystack.includes(query);
    }

    function refreshUI() {
      const contacts = loadContacts();
      const today = todayISO();
      const filterValue = $("filterSelect").value;
      const searchValue = clean($("searchInput").value).toLowerCase();

      const sel = $("contactSelect");
      sel.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = ""; o0.textContent = "â€” sÃ©lectionner â€”";
      sel.appendChild(o0);

      contacts
        .slice()
        .sort((a,b)=> (a.prenom||"").localeCompare(b.prenom||""))
        .forEach((c) => {
          const o = document.createElement("option");
          o.value = contactKey(c);
          o.textContent = `${c.prenom || "(sans prÃ©nom)"} â€¢ ${c.plateforme || ""}`;
          sel.appendChild(o);
        });

      if (selectedKey && getContactByKey(contacts, selectedKey)) {
        sel.value = selectedKey;
      } else {
        selectedKey = "";
        sel.value = "";
      }

      const relanceCount = contacts.filter((c) => isUrgent(c, today)).length;
      $("relanceCount").textContent = `Relances du jour : ${relanceCount}`;

      const contactsForDisplay = contacts
        .filter((c) => matchesFilter(c, filterValue, today))
        .filter((c) => matchesSearch(c, searchValue))
        .slice()
        .sort((a, b) => {
          const da = a.prochaine_relance || "";
          const db = b.prochaine_relance || "";
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da.localeCompare(db);
        });

      const tbody = $("contactTableBody");
      tbody.innerHTML = "";

      contactsForDisplay.forEach((c) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.title = "Clique pour charger ce contact";
        tr.addEventListener("click", () => {
          selectedKey = contactKey(c);
          $("contactSelect").value = selectedKey;
          fillFormFromContact(c);
        });

        const td1 = document.createElement("td"); td1.textContent = c.prenom || "";
        const td2 = document.createElement("td"); td2.textContent = c.plateforme || "";

        const td3 = document.createElement("td");
        td3.textContent = c.statut || "";
        if (isUrgent(c, today)) {
          const badge = document.createElement("span");
          badge.className = "badge-urgent";
          badge.textContent = "URGENT";
          td3.append(" ", badge);
        }

        const td4 = document.createElement("td");
        td4.textContent = c.prochaine_relance ? `${c.prochaine_relance}${formatFollowUpSuffix(c.prochaine_relance)}` : "";

        const td5 = document.createElement("td"); td5.textContent = c.note || "";

        tr.append(td1, td2, td3, td4, td5);
        tbody.appendChild(tr);
      });
    }

    function addOrUpdateContact() {
      const c = getFormAsContact();
      if (!c.prenom) { alert("Ajoute au moins un prÃ©nom pour enregistrer ğŸ™‚"); return; }

      const contacts = loadContacts();
      const key = contactKey(c);
      const i = contacts.findIndex(x => contactKey(x) === key);

      if (i < 0 && !c.date_creation) c.date_creation = todayISO();
      c.prochaine_relance = computeNextFollowUp(c);

      $("dateCreation").value = c.date_creation;
      $("prochaine").value = c.prochaine_relance;

      if (i >= 0) contacts[i] = c; else contacts.push(c);
      saveContacts(contacts);

      selectedKey = key;
      refreshUI();
    }

    function deleteSelectedContact() {
      const key = $("contactSelect").value || selectedKey;
      if (!key) return;

      const contacts = loadContacts();
      const i = contacts.findIndex((c) => contactKey(c) === key);
      if (i < 0) return;

      const name = contacts[i]?.prenom || "ce contact";
      if (!confirm(`Supprimer ${name} ?`)) return;

      contacts.splice(i, 1);
      saveContacts(contacts);

      if (selectedKey === key) selectedKey = "";
      refreshUI();
    }

    function updateSelectedContact(updateFn) {
      const key = $("contactSelect").value || selectedKey;
      if (!key) { alert("SÃ©lectionne un contact dâ€™abord."); return; }
      const contacts = loadContacts();
      const i = contacts.findIndex((c) => contactKey(c) === key);
      if (i < 0) return;

      const updated = { ...contacts[i] };
      updateFn(updated);
      contacts[i] = updated;
      saveContacts(contacts);
      selectedKey = key;
      refreshUI();
    }

    function markAsReplied() {
      updateSelectedContact((c) => {
        c.statut = "RÃ©pondu";
        c.dernier = todayISO();
        c.prochaine_relance = "";
      });
    }

    function planFollowUp(days, objectif) {
      updateSelectedContact((c) => {
        c.statut = "Ã€ relancer";
        c.objectif = objectif;
        if (!c.dernier) c.dernier = todayISO();
        c.prochaine_relance = addDaysISO(todayISO(), days);
      });
    }

    // --------- CSV ---------
    const CSV_HEADERS = ["prenom","plateforme","relation","objectif","style","longueur","persona","intention","statut","date_creation","dernier","prochaine_relance","centre","accroche","note"];

    function escapeCSV(value) {
      const s = String(value ?? "");
      if (/[",\n\r;]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function toCSVRow(obj) {
      return CSV_HEADERS.map(h => escapeCSV(obj[h] ?? "")).join(",");
    }

    function exportCSV() {
      const contacts = loadContacts();
      const lines = [CSV_HEADERS.join(",")];
      contacts.forEach(c => lines.push(toCSVRow(c)));
      const csv = lines.join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "contacts_mlm.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function parseCSV(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            const next = text[i+1];
            if (next === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += ch; i++; continue;
        } else {
          if (ch === '"') { inQuotes = true; i++; continue; }
          if (ch === ',') { row.push(field); field=""; i++; continue; }
          if (ch === '\n') { row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
          if (ch === '\r') { i++; continue; }
          field += ch; i++; continue;
        }
      }
      row.push(field); rows.push(row);
      return rows;
    }

    function importCSVFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        if (rows.length < 1) { alert("CSV vide."); return; }

        const headers = rows[0].map(h => h.trim());
        const map = {};
        headers.forEach((h, idx) => map[h] = idx);

        if (map["prenom"] == null) { alert("CSV invalide : colonne 'prenom' introuvable."); return; }

        const imported = [];
        for (let r = 1; r < rows.length; r++) {
          const line = rows[r];
          if (line.length === 1 && !line[0]) continue;

          const obj = {};
          CSV_HEADERS.forEach(h => {
            const idx = map[h];
            obj[h] = (idx != null && idx < line.length) ? (line[idx] || "") : "";
          });

          if (!obj.plateforme) obj.plateforme = "Instagram";
          if (!obj.relation) obj.relation = "froid";
          if (!obj.objectif) obj.objectif = "discussion";
          if (!obj.style) obj.style = "neutre";
          if (!obj.longueur) obj.longueur = "normal";
          if (!obj.persona) obj.persona = "indefini";
          if (!obj.intention) obj.intention = "reseau";
          if (!obj.statut) obj.statut = "Nouveau";
          if (!obj.date_creation) obj.date_creation = todayISO();

          if (obj.statut === "Ã€ relancer" && !obj.prochaine_relance) {
            obj.prochaine_relance = computeNextFollowUp(obj);
          }

          if (clean(obj.prenom)) imported.push(obj);
        }

        const contacts = loadContacts();
        imported.forEach(c => {
          const key = contactKey(c);
          const i = contacts.findIndex(x => contactKey(x) === key);
          if (i >= 0) contacts[i] = c; else contacts.push(c);
        });

        saveContacts(contacts);
        refreshUI();
        alert(`Import terminÃ© âœ… (${imported.length} contact(s))`);
      };
      reader.readAsText(file, "utf-8");
    }

    // --------- events ---------
    $("btnGen").addEventListener("click", generate);
    $("btnRandom").addEventListener("click", generate);

    $("btnCopy").addEventListener("click", async () => {
      const text = $("result").value;
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        $("btnCopy").textContent = "CopiÃ© âœ…";
        setTimeout(() => $("btnCopy").textContent = "Copier", 900);
      } catch {
        alert("Copie impossible. SÃ©lectionne le texte et fais Ctrl+C.");
      }
    });

    $("btnClear").addEventListener("click", () => {
      ["prenom","centre","accroche","note","dernier","prochaine"].forEach(id => $(id).value = "");
      $("dateCreation").value = "";
      $("plateforme").value = "Instagram";
      $("relation").value = "froid";
      $("objectif").value = "discussion";
      $("styleTone").value = "neutre";
      $("lengthMode").value = "normal";
      $("persona").value = "indefini";
      $("intention").value = "reseau";
      $("statut").value = "Ã€ relancer";
      $("result").value = "";
      $("debug").textContent = "";
      $("daysInfo").textContent = "";
      selectedKey = "";
      generate();
      refreshUI();
    });

    $("btnAdd").addEventListener("click", addOrUpdateContact);
    $("btnDelete").addEventListener("click", deleteSelectedContact);
    $("btnMarkReplied").addEventListener("click", markAsReplied);
    $("btnPlan7").addEventListener("click", () => planFollowUp(7, "relance7"));
    $("btnPlan14").addEventListener("click", () => planFollowUp(14, "relance14"));

    $("contactSelect").addEventListener("change", () => {
      const contacts = loadContacts();
      selectedKey = $("contactSelect").value;
      if (!selectedKey) return;
      const found = getContactByKey(contacts, selectedKey);
      if (!found) return;
      fillFormFromContact(found);
    });

    $("filterSelect").addEventListener("change", refreshUI);
    $("searchInput").addEventListener("input", refreshUI);

    $("btnExport").addEventListener("click", exportCSV);
    $("btnImportBtn").addEventListener("click", () => $("importFile").click());
    $("importFile").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      importCSVFile(file);
      e.target.value = "";
    });

    // Auto recalcul si tu changes (statut/objectif/dernier)
    function autoSuggestNext() {
      const statut = $("statut").value;
      if (statut !== "Ã€ relancer") return;
      const base = $("dernier").value || todayISO();
      const obj = $("objectif").value;
      const next = (obj === "relance14") ? addDaysISO(base, 14) : addDaysISO(base, 7);
      $("prochaine").value = next;
    }
    $("statut").addEventListener("change", autoSuggestNext);
    $("objectif").addEventListener("change", autoSuggestNext);
    $("dernier").addEventListener("change", autoSuggestNext);

    // init
    refreshUI();
    generate();
    autoSuggestNext();
  </script>
</body>
</html>
